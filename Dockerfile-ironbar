FROM golang:1.21-alpine AS builder
RUN apk add build-base

WORKDIR /app

COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY ./cmd/ironbar ./cmd/ironbar
COPY ./pkg ./pkg

RUN ls -l

ARG GOFLAGS
RUN go build $GOFLAGS -trimpath -mod=readonly ./cmd/ironbar

#-------------------------------------------------------------------

FROM alpine
MAINTAINER Ian Davis <ian.davis@protocol.ai>

COPY --from=builder /app/ironbar /app/ironbar
COPY --from=builder /etc/ssl/certs /etc/ssl/certs

CMD [ "/app/ironbar"]
